name: Azure Database Deployment

on:
  workflow_call:
    secrets:
      DATABASE_URL:
        required: true
      AZURE_POSTGRES_PASSWORD:
        required: true

jobs:
  deploy-database:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'npm'
    
    - name: Install dependencies
      run: npm ci
    
    - name: Test Azure database connection
      run: |
        echo "üîó Testing Azure database connection..."
        node -e "
          const { Client } = require('pg');
          const client = new Client({ connectionString: process.env.DATABASE_URL });
          
          async function testConnection() {
            try {
              await client.connect();
              const result = await client.query('SELECT current_database(), current_user, COUNT(*) as table_count FROM information_schema.tables WHERE table_schema = \\'public\\'');
              console.log('‚úÖ Azure database connection successful:', result.rows[0]);
              await client.end();
            } catch (err) {
              console.log('‚ùå Azure database connection failed:', err.message);
              process.exit(1);
            }
          }
          
          testConnection();
        "
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}

    - name: Deploy database schema using Drizzle
      run: |
        echo "üèóÔ∏è Deploying complete database schema to Azure..."
        npm run db:push --force
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        NODE_ENV: production

    - name: Verify schema deployment
      run: |
        echo "üîç Verifying schema deployment..."
        node -e "
          const { Client } = require('pg');
          const client = new Client({ connectionString: process.env.DATABASE_URL });
          
          async function verifySchema() {
            try {
              await client.connect();
              
              // Check table count
              const tableResult = await client.query('SELECT COUNT(*) as table_count FROM information_schema.tables WHERE table_schema = \\'public\\'');
              console.log('üìä Tables deployed:', tableResult.rows[0].table_count);
              
              // Check for key tables
              const keyTables = await client.query(\`
                SELECT table_name FROM information_schema.tables 
                WHERE table_schema = 'public' 
                AND table_name IN ('users', 'mentors', 'students', 'bookings', 'reviews', 'achievements')
                ORDER BY table_name
              \`);
              console.log('üîë Key tables found:', keyTables.rows.map(r => r.table_name));
              
              if (keyTables.rows.length < 6) {
                console.log('‚ùå Missing key tables');
                process.exit(1);
              }
              
              console.log('‚úÖ Schema deployment verified');
              await client.end();
            } catch (err) {
              console.log('‚ùå Schema verification failed:', err.message);
              process.exit(1);
            }
          }
          
          verifySchema();
        "
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}

    - name: Sync complete Replit data to Azure (with safety checks)
      run: |
        echo "üîÑ Syncing complete Replit data to Azure database..."
        echo "üìä This will copy all 29 records from Replit ‚Üí Azure"
        echo "üõ°Ô∏è SAFETY: Will NOT sync if Azure has >50 records (protects real data)"
        echo "‚ö†Ô∏è WARNING: Will warn if Azure has 10-50 records"
        echo "‚úÖ SAFE: Will sync if Azure has <10 records"
        cd server && npx tsx sync-to-azure.ts
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}
        NODE_ENV: production

    - name: Verify final database state
      run: |
        echo "‚úÖ Verifying final Azure database state..."
        node -e "
          const { Client } = require('pg');
          const client = new Client({ connectionString: process.env.DATABASE_URL });
          
          async function verifyFinalState() {
            try {
              await client.connect();
              
              // Get final counts
              const userResult = await client.query('SELECT COUNT(*) as count FROM users');
              const mentorResult = await client.query('SELECT COUNT(*) as count FROM mentors');
              const studentResult = await client.query('SELECT COUNT(*) as count FROM students');
              const bookingResult = await client.query('SELECT COUNT(*) as count FROM bookings');
              
              console.log('üéâ Final Azure database state:');
              console.log('Users:', userResult.rows[0].count);
              console.log('Mentors:', mentorResult.rows[0].count);
              console.log('Students:', studentResult.rows[0].count);
              console.log('Bookings:', bookingResult.rows[0].count);
              
              // Verify test accounts exist
              const testAccounts = await client.query(\`
                SELECT email, role FROM users 
                WHERE email IN ('teacher@codeconnect.com', 'udayakirang99@gmail.com', 'admin@codeconnect.com')
                ORDER BY role
              \`);
              
              console.log('üîê Test accounts verified:');
              testAccounts.rows.forEach(account => {
                console.log(\`- \${account.email} (\${account.role})\`);
              });
              
              // Verify complete sync from Replit (should have 19 users, 5 mentors, 5 students)
              const userCount = parseInt(userResult.rows[0].count);
              const mentorCount = parseInt(mentorResult.rows[0].count);
              const studentCount = parseInt(studentResult.rows[0].count);
              
              if (testAccounts.rows.length >= 3 && userCount >= 19 && mentorCount >= 5 && studentCount >= 5) {
                console.log('‚úÖ Complete Replit data sync verified!');
                console.log(\`üìä Successfully synced: \${userCount} users, \${mentorCount} mentors, \${studentCount} students\`);
              } else {
                console.log('‚ùå Incomplete data sync detected');
                console.log(\`Expected: ‚â•19 users, ‚â•5 mentors, ‚â•5 students, 3 test accounts\`);
                console.log(\`Got: \${userCount} users, \${mentorCount} mentors, \${studentCount} students, \${testAccounts.rows.length} test accounts\`);
                process.exit(1);
              }
              
              await client.end();
            } catch (err) {
              console.log('‚ùå Final verification failed:', err.message);
              process.exit(1);
            }
          }
          
          verifyFinalState();
        "
      env:
        DATABASE_URL: ${{ secrets.DATABASE_URL }}